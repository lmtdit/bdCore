// Generated by CoffeeScript 1.9.3

/**
 * gulpfile
 * @date 2014-12-2 15:57:21
 * @author pjg <iampjg@gmail.com>
 * @link http://pjg.pw
 * @version $Id$
 */
var _cfg, _cfgData, _cfgFile, build, cfg, color, cp, env, exec, fs, gulp, gutil, helper, isDebug, jsdoc, path, release, taskCtrl;

fs = require('fs');

path = require('path');

gulp = require('gulp');

jsdoc = require('gulp-jsdoc');

gutil = require('gulp-util');

color = gutil.colors;

cp = require('child_process');

exec = cp.exec;

taskCtrl = require('./lib/taskCtrl');

helper = function() {
  gutil.log(color.yellow.bold("前端开发框架使用说明："));
  gutil.log(color.cyan("以gulp命令启动程序，它可接收两个参数，分别是"));
  gutil.log(color.cyan("参数1： --env 或者 --e"));
  gutil.log(color.cyan("此参数是环境参数，默认值为'local'，其他值分别为test、rc、www"));
  gutil.log(color.cyan("参数1： --debug 或者 --d"));
  gutil.log(color.cyan("此参数为调试开关，默认值为false"));
  gutil.log(color.yellow.bold("eg: "));
  gutil.log(color.cyan("1、local开发环境的watch命令："));
  gutil.log(color.cyan("gulp 或者 gulp --e local 或者 gulp --env local"));
  gutil.log(color.cyan("2、local开发环境的debug命令："));
  gutil.log(color.cyan("gulp --d 或者 gulp --env local --d"));
  gutil.log(color.cyan("3、test环境下发布代码："));
  return gutil.log(color.cyan("gulp --e test 或者 gulp --env test"));
};

gulp.task('helper', function() {
  return helper();
});

_cfgFile = path.join(process.env.INIT_CWD, 'config.json');

if (!fs.existsSync(_cfgFile)) {
  gutil.log(color.yellow("config.json is missing!"));
  _cfg = require('./data/default.json');
  _cfgData = JSON.stringify(_cfg, null, 4);
  fs.writeFileSync(_cfgFile, _cfgData, 'utf8');
  gutil.log(color.yellow("config.json rebuild success!"));
  gutil.log(color.green("Run Gulp Task again! Plzzzzz..."));
  gulp.task('default', [], function() {
    return helper();
  });
  return false;
}

cfg = require('./lib/config');

build = require('./lib/build');

env = cfg.env;

isDebug = cfg.isDebug;


/*
 * Initialization program
 */

gulp.task('init', function() {
  build.init();
  return exec("gulp -T", function(error, stdout, stderr) {
    console.log(stdout);
    return gulp.start(['helper']);
  });
});


/*
 * clean files
 */

gulp.task('del.data', function() {
  return build.files.delJson();
});

gulp.task('clean', function() {
  return build.files.delDistFiles();
});


/*
 * build sprite,less,css,js,tpl...
 */

gulp.task('jslibs', function() {
  return build.jsLibs();
});

gulp.task('jspaths', function() {
  return build.jsPaths();
});

gulp.task('cfg', function() {
  return build.cfg();
});

gulp.task('tpl', function() {
  return build.tpl2dev();
});

gulp.task('js2dev', function() {
  return build.js2dev();
});

gulp.task('js2dist', function() {
  return build.js2dist();
});

gulp.task('noamd', function() {
  return build.noamd();
});

gulp.task('corejs', function() {
  return build.corejs();
});

gulp.task('sprite', function() {
  return build.sprite();
});

gulp.task('bgmap', function() {
  return build.bgMap();
});

gulp.task('less', function() {
  return build.less2css();
});

gulp.task('css', function() {
  return build.bgMap(function() {
    return build.css2dist();
  });
});

gulp.task('map', function() {
  return build.json2php();
});


/*
 * push all files to dist
 */

gulp.task('all', function() {
  return build.all2dist();
});


/*
 * html demo files
 */

gulp.task('html', function() {
  return build.htmlctl();
});


/*
 * php Tpl
 */

gulp.task('php', function() {
  return build.phpctl();
});


/*
 * build bat tool
 */

gulp.task('doc', function() {
  return gulp.src([cfg.jsSrcPath + '**/*.js', './README.md']).pipe(jsdoc.parser({
    plugins: ['plugins/markdown'],
    markdown: {
      "parser": "gfm"
    }
  })).pipe(jsdoc.generator(cfg.docOutPath, {
    path: 'ink-docstrap',
    theme: 'Cerulean',
    systemName: 'v.Builder',
    linenums: true,
    collapseSymbols: true,
    inverseNav: false
  }, {
    "private": false,
    monospaceLinks: false,
    cleverLinks: true,
    outputSourceFiles: true
  }));
});


/*
 * watch tasks
 */

gulp.task('watch', function() {
  return build.autowatch(function() {

    /*
    clearTimeout _gitTimer if _gitTimer
    _gitTimer = setTimeout ->
        rootPath = path.join __dirname
        disk = rootPath.split('')[0]
        if disk != '/' 
            exec 'cmd ./bin/autogit.bat',(error, stdout, stderr)->
                console.log stdout
        else
            exec 'sh ./bin/autogit.sh',(error, stdout, stderr)->
                console.log stdout
    ,3000
     */
  });
});


/*
 * release function
 */

release = function() {
  var _startTime, cssFn, jsFn, releaseTask;
  cssFn = function(mainCb) {

    /*css相关任务 start */
    var cssTask;
    cssTask = new taskCtrl({
      drain: function() {
        return build.css2dist(function() {
          return mainCb();
        });
      }
    });

    /*less任务 */
    cssTask.add({
      name: 'less',
      task: function(cb) {
        return build.less(function() {
          return cb();
        });
      }
    }, function(err) {
      if (err) {
        gutil.log(err);
      }
      return gutil.log('task:less is finished');
    });

    /*bgMap任务 */
    return cssTask.add({
      name: 'bgMap',
      task: function(cb) {
        return build.bgMap(function() {
          return cb();
        });
      }
    }, function(err) {
      if (err) {
        gutil.log(err);
      }
      return gutil.log('task:bgMap is finished');
    });

    /*css相关任务 end */
  };
  jsFn = function(mainCb) {
    return build.js(function() {

      /*js相关任务 start */
      var jsTask;
      jsTask = new taskCtrl({
        drain: function() {
          return build.js2dist(function() {
            return mainCb();
          });
        }
      });

      /*corejs任务 */
      jsTask.add({
        name: 'corejs',
        task: function(cb) {
          return build.corejs(function() {
            return cb();
          });
        }
      }, function(err) {
        if (err) {
          gutil.log(err);
        }
        return gutil.log('task:corejs is finished');
      });

      /*noamd任务 */
      return jsTask.add({
        name: 'noamd',
        task: function(cb) {
          return build.noamd(function() {
            return cb();
          });
        }
      }, function(err) {
        if (err) {
          gutil.log(err);
        }
        return gutil.log('task:noamd is finished');
      });
    });

    /*js相关任务 end */
  };
  _startTime = (new Date()).getTime();
  releaseTask = new taskCtrl({
    drain: function() {
      gutil.log(color.cyan("构建map..."));
      return setTimeout(function() {
        var _endTime;
        build.json2php();
        gutil.log(color.cyan("构建完成，可以发版了..."));
        _endTime = (new Date()).getTime();
        return gutil.log(color.cyan("耗时：" + (_endTime - _startTime) / 1000 + 's...'));
      }, 2000);
    }
  });
  releaseTask.add({
    name: 'mainCss',
    task: function(cb) {
      return cssFn(cb);
    }
  }, function(err) {
    if (err) {
      gutil.log(err);
    }
    return gutil.log('task:mainCss is finished');
  });
  return releaseTask.add({
    name: 'mainJs',
    task: function(cb) {
      return jsFn(cb);
    }
  }, function(err) {
    if (err) {
      gutil.log(err);
    }
    return gutil.log('task:mainJs is finished');
  });

  /*
  build.less ->
      build.bgMap ->
          build.css2dist ->
              build.js ->
                  build.corejs ->
                      build.noamd ->
                          build.js2dist ->
                              gutil.log color.cyan "构建map..."
                              setTimeout ->
                                  build.json2dist ->
                                      build.json2php()
                                      gutil.log color.cyan "构建完成，可以发版了..."
                              ,2000
   */
};

gulp.task('default', [], function() {
  var debugTask;
  if (env === 'local' && !isDebug) {
    debugTask = new taskCtrl({
      drain: function() {
        return build.htmlctl(function() {
          var _Timer;
          build.phpctl();
          if (_Timer) {
            clearTimeout(_Timer);
          }
          return _Timer = setTimeout(function() {
            return gulp.start(['watch']);
          }, 2000);
        });
      }
    });

    /*less任务 */
    debugTask.add({
      name: 'less',
      task: function(cb) {
        return build.less(function() {
          return cb();
        });
      }
    }, function(err) {
      if (err) {
        gutil.log(err);
      }
      return gutil.log('task:less is finished');
    });

    /*js任务 */
    return debugTask.add({
      name: 'js',
      task: function(cb) {
        return build.js(function() {
          return cb();
        });
      }
    }, function(err) {
      if (err) {
        gutil.log(err);
      }
      return gutil.log('task:js is finished');
    });

    /*
    setTimeout ->
        build.less ->
            build.js ->
                build.htmlctl ->
                    clearTimeout _Timer if _Timer
                    _Timer = setTimeout ->
                        gulp.start ['watch']
                    ,2000
    ,100
     */
  } else {
    return release();
  }
});

gulp.task('release', [], function() {
  return release();
});
